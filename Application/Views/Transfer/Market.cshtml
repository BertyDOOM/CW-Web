@using Entities.ViewModels
@model MarketPageViewModel
@{
}
<div class="top-filler">
    <div class="filler-text-wrap">MARKET PLACE</div>
    <div class="filler-effect-2"></div>
</div>
<div class="home-grid">
    <div></div>
    <div class="market-column">

        @if (Model.UserTeam.OwnedCoachId == null)
        {
          <h2 class="market-title">Coaches</h2>

            <div class="market-list">
            @foreach (var club in Model.Clubs.Where(c => c.Coach != null))
            {
                <a href="#coach-@club.Coach.Id" class="market-row-simple coach-row-simple">

                    <div class="club-logo-simple">
                        <img src="@club.Coach.ClubUrl" />
                    </div>

                    <div class="player-info-simple">
                        <div class="player-name-simple">@club.Coach.Name</div>
                        <div class="player-pos-simple">Coach</div>
                    </div>

                    <div class="player-price-simple">
                        0 coins
                    </div>

                </a>

                @await Html.PartialAsync("_CoachInfoRecruitPartial", club.Coach)
            }
        </div>  
        }
        

        <h2 class="market-title">Players</h2>

        <div class="market-list">
            @foreach (var club in Model.Clubs)
            {
                @foreach (var mp in club.Players)
                {
                    <a href="#player-@mp.Info.Id" class="market-row-simple">

                        <div class="club-logo-simple">
                            <img src="@mp.Info.ClubUrl" />
                        </div>

                        <div class="player-info-simple">
                            <div class="player-name-simple">@mp.Info.Name</div>
                            <div class="player-pos-simple">@mp.Info.Position</div>
                        </div>

                        <div class="player-price-simple">
                            @mp.Price coins
                        </div>

                    </a>

                     @await Html.PartialAsync("_PlayerInfoBuyPartial", mp.Info) 
                }
            }
        </div>
    </div>

    <div></div> 
</div>

<style>
    .home-grid {
        display: grid;
        grid-template-columns: 1fr 2.3fr 1fr; /* уголемена средна */
        gap: 20px;
    }

    .market-column {
        background: white;
        border-radius: 10px;
        padding: 20px;
        height: 100%;
        overflow-y: auto;
    }

    .market-title {
		margin: 10px 0;
		    font-size: 1.4rem;
        font-weight: 700;
        color: #37003C;
    }

    /* === LIST === */
    .market-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* === ROW === */
    .market-row {
        display: grid;
        grid-template-columns: 50px 1fr 110px;
        align-items: center;
        height: 55px;
        padding: 0px 6px 10px 6px;
		background: rgb(100, 220, 210);
        border-radius: 6px;
        text-decoration: none;
        color: inherit;
        transition: background 0.15s, transform 0.1s;
    }

    .market-row-simple {
        display: table;
        width: 100%;
        height: 56px;
        background: rgb(100, 220, 210);
        border-radius: 1px;
        text-decoration: none;
        color: inherit;
        box-sizing: border-box;
    }

    .club-logo-simple,
    .player-info-simple,
    .player-price-simple {
        display: table-cell; /* или inline-block */
        vertical-align: middle;
        padding: 0 10px;
        font-weight: 700;
        font-size: 0.85rem;
        color: #00cd84;
        line-height: 30px; 
    }

    /* LOGO */
    .club-logo-simple {
        width: 50px;
        padding-left: 6px;
    }

        .club-logo-simple img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

    .player-info-simple {
        padding: 0 10px;
        width: 100%;
    }

    /* ИМЕТО СЕ РАЗТЯГА НА 100% */
    .player-name-simple {
        display: block;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.10);
        font-weight: 600;
        font-size: 0.95rem;
        color: #37003C;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ПОЗИЦИЯ */
    .player-pos-simple {
        font-size: 0.75rem;
        color: #555;
    }

    /* COACH tweak */
    .coach-row-simple {
        background: rgba(0, 120, 255, 0.12);
    }

</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const buyButtons = document.querySelectorAll(".starter-btn");

        buyButtons.forEach(btn => {
            btn.addEventListener("click", async function(e) {
                e.preventDefault();

                const playerId = parseInt(this.dataset.playerId);
                const pos = parseInt(this.dataset.pos);
                const price = 1000; // можеш да вземеш динамично от реда

                try {
                    const res = await fetch("/Transfer/BuyPlayer", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({ PlayerId: playerId, SchemePosition: pos, Price: price })
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        alert("Error: " + text);
                        return;
                    }

                    const data = await res.json();
                    console.log("Player bought:", data);

                    // Обновяване на UI
                    alert("Bought Player! " + (data.isStarter ? "He is now starter." : "He is on bench."));

                    // Маркираме бутона като активен, ако е starter
                    if(data.isStarter) {
                        document.querySelectorAll(`.starter-btn[data-player-id="${playerId}"]`)
                            .forEach(b => b.classList.remove("active"));
                        this.classList.add("active");
                    }

                    // Обновяване на монетите на потребителя
                    const coinsDiv = document.querySelector(".user-points");
                    if (coinsDiv) coinsDiv.textContent = data.newCoins + " coins";

                } catch (err) {
                    console.error(err);
                    alert("Error with buying.");
                }
            });
        });
    });
</script>