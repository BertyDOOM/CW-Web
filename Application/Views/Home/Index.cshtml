﻿@using Entities.ViewModels
@model UserTeamViewModel
@{
    ViewData["Title"] = "My Fantasy Team";
}

<div class="top-filler">
    <div class="filler-text-wrap">YOUR TEAM</div>
    <div class="filler-effect"></div>
</div>

<div class="home-grid">

    <div class="grid-div-user">
        <div class="favorite-club-crest">
            @if (!string.IsNullOrEmpty(Model.FavoriteClubCrestUrl))
            {
                <img src="@Model.FavoriteClubCrestUrl" alt="@Model.FavoriteClubName" />
            }
            else
            {
                <div class="no-crest">No Club</div>
            }
        </div>
        <div>
            <div class="user-details">
                <div class="user-name">@Model.TeamName</div>
                <div class="user-points">@Model.UserPoints <span>points</span></div>
                <div class="user-points">@Model.UserCoins <span>coins</span></div>
            </div>
        </div>
    </div>

    <div class="grid-div-squad">
        <div class="pitch">

            <div class="grid-row grid-row-GK">
                @{
                    var Gk = Model.StarterPlayers?.Where(p => p.SchemePosition == 1).ToList() ?? new List<PlayerViewModel>();
                }
                @if (Gk.Any())
                {
                    @foreach (var p in Gk)
                    {
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                }
                else
                {
                    <div class="empty-card"></div>
                }

            </div>

            <div class="grid-row grid-row-Defense">
                @{
                    var Def = Model.StarterPlayers?.Where(p => p.SchemePosition >= 2 && p.SchemePosition <= 5)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 2; i <= 5; i++)
                {
                    if (Def.ContainsKey(i))
                    {
                        PlayerViewModel p = Def[i];
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
                        <div class="empty-card"></div>
                    }
                }
            </div>

            <div class="grid-row grid-row-Midfield">
                @{
                    var Mid = Model.StarterPlayers?.Where(p => p.SchemePosition >= 6 && p.SchemePosition <= 9)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 6; i <= 9; i++)
                {
                    if (Mid.ContainsKey(i))
                    {
                        PlayerViewModel p = Mid[i];
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
                        <div class="empty-card"></div>
                    }
                }
            </div>

            <div class="grid-row grid-row-FW">
                @{
                    var Fw = Model.StarterPlayers?.Where(p => p.SchemePosition >= 10 && p.SchemePosition <= 11)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 10; i <= 11; i++)
                {
                    if (Fw.ContainsKey(i))
                    {
                        PlayerViewModel p = Fw[i];
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
                        <div class="empty-card"></div>
                    }
                }
            </div>


            <div class="bench">
                @if (Model.Coach != null)
                {
                    <div class="coach-card">
                        <img src="~/img/trainee Kit.png" />
                        <a href="#coach-@Model.Coach.Id" class="player-name">@Model.Coach.Name</a>
                        @await Html.PartialAsync("_CoachInfoPartial", Model.Coach)
                    </div>
                }
                else
                {
                    <div class="empty-card"></div>
                }
                <div class="bench-select-wrapper">
                    <label for="bench-select" style="color:white; font-weight:500;">Bench:</label>
                    <select id="bench-select" name="bench-player"
                            style="width:100%; padding:4px; border-radius:4px; margin-top:4px;"
                            onchange="if(this.value) location.href='#player-'+this.value">
                        @if (Model.BenchPlayers.Any())
                        {
                            <option value="">Select a player</option>
                            @foreach (var p in Model.BenchPlayers)
                            {
                                <option value="@p.Id">@p.Name</option>


                            }

                        }
                        else
                        {
                            <option value="">No bench players</option>
                        }

                    </select>
                    @foreach (var p in Model.BenchPlayers)
                    {
                        @await Html.PartialAsync("_PlayerInfoMakeStarterPartial", p)
                    }
                </div>
            </div>



        </div>
    </div>
    <div class="grid-div territory-card">
        <div class="territory-image">
            <img src="~/img/England territory.png" alt="England territory" />
        </div>
        <div class="territory-link">
            <a asp-controller="Transfer" asp-action="Market">
                Go to the Marketplace
            </a>
        </div>
    </div>
</div>


<script>
    let dragged = null;

    document.addEventListener('dragstart', e => {
        if (!e.target.classList.contains('player-card')) return;
        dragged = e.target;
        dragged.classList.add('dragging');
    });

    document.addEventListener('dragend', e => {
        if (!dragged) return;
        dragged.classList.remove('dragging');
        dragged = null;
    });

    document.querySelectorAll('.grid-row').forEach(row => {
        row.addEventListener('dragover', e => e.preventDefault());
        row.addEventListener('dragleave', e => row.classList.remove('dragover'));

        row.addEventListener('drop', async e => {
            e.preventDefault();
            row.classList.remove('dragover');
            if (!dragged) return;

            const targetCard = e.target.closest('.player-card');

            if (targetCard && targetCard !== dragged) {
                const draggedParent = dragged.parentNode;
                const targetParent = targetCard.parentNode;

                // визуален swap
                const draggedNext = dragged.nextSibling === targetCard ? dragged : dragged.nextSibling;
                const targetNext = targetCard.nextSibling === dragged ? targetCard : targetCard.nextSibling;

                targetParent.insertBefore(dragged, targetCard);
                draggedParent.insertBefore(targetCard, draggedNext);

                // вземаме PlayerId за AJAX
                const pos1 = parseInt(dragged.dataset.playerId);
                const pos2 = parseInt(targetCard.dataset.playerId);

                // извикване на контролера за swap в DB
                try {
                    const response = await fetch('/Home/SchemePositionChanger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pos1, pos2 })
                    });

                    if (!response.ok) throw new Error('Network error');

                    const data = await response.json();
                    console.log('DB updated:', data);

                    // актуализираме dataset, ако е нужно
                    dragged.dataset.playerId = data[0].PlayerId;
                    targetCard.dataset.playerId = data[1].PlayerId;

                } catch (err) {
                    console.error('Error updating SchemePosition:', err);
                    // при грешка може да върнем картите обратно
                }

            } else {
                // празно място – просто премести
                row.appendChild(dragged);
            }
        });
    });
        document.addEventListener('DOMContentLoaded', () => {
        // Всички бутони за starter
        document.querySelectorAll('.starter-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const playerId = parseInt(this.dataset.playerId);
                const schemePosition = parseInt(this.dataset.pos);
                if (!schemePosition) return;

                try {
                    const res = await fetch('/Home/MakeStarter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ PlayerId: playerId, SchemePosition: schemePosition })
                    });

                    if (!res.ok) throw new Error('Network error');

                    // Презареждаме страницата за визуализиране на новия starter
                    location.reload();

                } catch (err) {
                    console.error(err);
                    alert('Error making player starter');
                }
            });
        });
    });
</script>