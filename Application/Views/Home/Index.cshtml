@using Entities.ViewModels
@model Entities.ViewModels.UserTeamViewModel
@{
    ViewData["Title"] = "My Fantasy Team";
}

<div class="top-filler">
    <div class="filler-text-wrap">YOUR TEAM</div>
    <div class="filler-effect"></div>
</div>

<div class="home-grid">
    <div class="grid-div-user">
        <div class="favorite-club-crest">
            @if (!string.IsNullOrEmpty(Model.FavoriteClubCrestUrl))
            {
                <img src="@Model.FavoriteClubCrestUrl" alt="@Model.FavoriteClubName" />
            }
            else
            {
                <div class="no-crest">No Club</div>
            }
        </div>
        <div>
            <div class="user-details">
                <div class="user-name">@Model.TeamName</div>
                <div class="user-points">@Model.UserPoints <span>points</span></div>
                <div class="user-points">@Model.UserCoins <span>coins</span></div>
            </div>
        </div>
    </div>

    <div class="grid-div-squad">
        <div class="pitch">

            <div class="grid-row grid-row-GK">
                @{
                    var Gk = Model.StarterPlayers?.Where(p => p.SchemePosition == 1).ToList() ?? new List<PlayerViewModel>();
                }
                @if (Gk.Any())
                {
                    @foreach (var p in Gk)
                    {
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                }else
                {
                    <div class="empty-card"></div>
                }

            </div>

            <div class="grid-row grid-row-Defense">
                @{
                    var Def = Model.StarterPlayers?.Where(p => p.SchemePosition >= 2 && p.SchemePosition <= 5)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 2; i <= 5; i++)
                {   if (Def.ContainsKey(i))
                    {
					PlayerViewModel p = Def[i];
                    <div class="player-card" draggable="true" data-player-id="@p.Id">
                        <img src="@p.KitUrl" />
                        <a href="#player-@p.Id" class="player-name">@p.Name</a>
                    </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
				        <div class="empty-card"></div>
                    }
                }
            </div>

            <div class="grid-row grid-row-Midfield">
                @{
                    var Mid = Model.StarterPlayers?.Where(p => p.SchemePosition >= 6 && p.SchemePosition <= 9)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 6; i <= 9; i++)
                {
                    if (Mid.ContainsKey(i))
                    {
                        PlayerViewModel p = Mid[i];
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
                        <div class="empty-card"></div>
                    }
                }
            </div>

            <div class="grid-row grid-row-FW">
                @{
                    var Fw = Model.StarterPlayers?.Where(p => p.SchemePosition >= 10 && p.SchemePosition <= 11)
                    .ToDictionary(p => p.SchemePosition.Value) ?? new Dictionary<int, PlayerViewModel>();
                }
                @for (int i = 10; i <= 11; i++)
                {
                    if (Fw.ContainsKey(i))
                    {
                        PlayerViewModel p = Fw[i];
                        <div class="player-card" draggable="true" data-player-id="@p.Id">
                            <img src="@p.KitUrl" />
                            <a href="#player-@p.Id" class="player-name">@p.Name</a>
                        </div>
                        @await Html.PartialAsync("_PlayerInfoPartial", p)
                    }
                    else
                    {
                        <div class="empty-card"></div>
                    }
                }
            </div>
			<div class="bench">
                 @if (Model.Coach != null)
                 {
                 <div class="coach-card">
                     <img src="~/img/trainee Kit.png" />
                     <div class="coach-name">@Model.Coach.Name</div>
                 </div>
                 }
                 else
                 {
                    <div class="empty-card"></div>
                 }
                 <div class="bench-select-wrapper">
                    <label for="bench-select" style="color:white; font-weight:500;">Bench:</label>
                    <select id="bench-select" name="bench-player" 
                            style="width:100%; padding:4px; border-radius:4px; margin-top:4px;"
                            onchange="if(this.value) location.href='#player-'+this.value">
                        @if (Model.BenchPlayers.Any())
                        {
                            <option value="">Select a player</option>
                            @foreach (var p in Model.BenchPlayers)
                            {
                                <option value="@p.Id">@p.Name</option>
                            
                           
                            }
                            
                        }
                        else
                        {
                        <option value="">No bench players</option>
                        }
                        
                    </select>
                    @foreach (var p in Model.BenchPlayers)
                    {
                        @await Html.PartialAsync("_PlayerInfoMakeStarterPartial", p)
                    }
                </div>
            </div>
                
                
             
			</div>
        </div>
        
    </div>

    <div class="grid-div">a</div>
</div>

<style>
    .top-filler {
        background-color: white;
        display: grid;
        grid-template-columns: 8fr 5fr;
        height: 100px;
    }

    .filler-text-wrap {
        font-family: 'Montserrat', sans-serif;
        padding-left: 20px;
        font-weight: 700;
        font-size: 36px;
        display: grid;
        align-items: end;
        color: rgb(55, 0, 60);
    }

    .filler-effect {
        background: linear-gradient(to right, transparent, deepskyblue);
    }

    .home-grid {
        display: grid;
        grid-template-columns: 1fr 1.5fr 1fr;
        gap: 20px;
        padding: 20px;
    }

    .grid-div {
        background-color: white;
        border-radius: 10px;
        height: 200px;
        padding: 20px;
    }

    .grid-div-user {
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        height: 200px;
        display: flex;
        flex-direction: row;
    }

    .grid-div-squad {
        background-color: white;
        border-radius: 10px;
        padding: 20px;
        height: 770px;
    }

    .favorite-club-crest img {
        width: 100px;
        height: 100px;
        object-fit: contain;
        border-radius: 4px;
        border: 2px solid rgb(55,0,60);
    }

    .no-crest {
        width: 60px;
        height: 60px;
        background-color: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #666;
        border-radius: 4px;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-left: 20px;
    }

    .user-name {
        font-weight: 600;
        font-size: 1.2rem;
        color: #37003C;
    }

    .user-points {
        font-weight: 700;
        font-size: 1.1rem;
        color: #00cd84;
    }

        .user-points span {
            font-weight: 400;
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }

    /* Pitch arc */
    .pitch {
        position: relative;
        background: url("/img/extended pitch.png") no-repeat center center;
        background-size: 100% 100%;
        box-sizing: border-box;
        display: grid;
        grid-template-rows: 130px 130px 130px 130px 140px;
        gap: 10px;
        /* padding: 10px; */
        border-radius: 10px;
        overflow: hidden;
        width: 100%;
    }

    .bench {
        background-color: rgba(0, 0, 0, 0.45);
        height: 140px;
        display: flex;
        align-items: center;
        padding-left: 27px;
        border-radius: 0 0 10px 10px;
    }

    .grid-row {
        display: grid;
        gap: 10px;
        height: 130px;
    }

    .grid-row-GK {
        grid-template-columns: 1fr;
        justify-items: center;
    }

    .grid-row-Defense, .grid-row-Midfield {
        grid-template-columns: repeat(4, 1fr);
        justify-items: center;
    }

    .grid-row-FW {
        grid-template-columns: 1fr 1fr;
        justify-items: center;
        margin: 0px 153px;
        gap: 50px;
    }

    .player-card {
        background-color: #37003C4D;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: grab;
        transition: transform 0.2s;
        width: 80px; 
        height: 125px; 
        flex-shrink: 0; 
    }

        .player-card.dragging {
            opacity: 0.7;
            transform: scale(1.1);
            z-index: 10;
        }

        .player-card img {
            width: 70px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 0px;
            user-drag: none;
            -webkit-user-drag: none;
            pointer-events: none;
        }

        .player-name {
            font-size: 0.8rem;
            text-align: center;
            margin-top: 0px;
            color: white;
            border-radius: 0 0 6px 6px;
            background-color: black;
            font-weight: 500;
            width: 100%;
            padding: 2px 0;
             text-decoration: none;
        }

        .player-name:hover {
            color: lightgray;
            text-decoration: none;
        }
        .coach-card {
		margin: 5px;
        border-radius : 6px;
        background-color: rgba(255, 255, 255, 0.45);
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: grab;
        transition: transform 0.2s;
        width: 80px;
        height: 125px;
        flex-shrink: 0;

    }

        .coach-card img {
            width: 80px;
            height: 110px;
            object-fit: contain;
            margin-bottom: 0px;
            user-drag: none;
            -webkit-user-drag: none;
            pointer-events: none;
        }

    .coach-name {
        font-size: 0.8rem;
        text-align: center;
        margin-top: 0px;
        color: white;
        background-color: black;
        font-weight: 500;
        width: 100%;
        padding: 2px 0;
        border-radius: 0 0 6px 6px;
    }

    .empty-card {
        background: url("/img/Go buy card.png") no-repeat center center;
        background-size: 100% 65%;
		position: relative;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s;
        width: 80px;
        height: 119px;
        flex-shrink: 0;
        border: 3px dashed rgb(82, 81, 89);
    }

    .bench-select-wrapper { padding-left: 100px;}
</style>

<script>
    let dragged = null;

    document.addEventListener('dragstart', e => {
        if (!e.target.classList.contains('player-card')) return;
        dragged = e.target;
        dragged.classList.add('dragging');
    });

    document.addEventListener('dragend', e => {
        if (!dragged) return;
        dragged.classList.remove('dragging');
        dragged = null;
    });

    document.querySelectorAll('.grid-row').forEach(row => {
        row.addEventListener('dragover', e => e.preventDefault());
        row.addEventListener('dragleave', e => row.classList.remove('dragover'));

        row.addEventListener('drop', async e => {
            e.preventDefault();
            row.classList.remove('dragover');
            if (!dragged) return;

            const targetCard = e.target.closest('.player-card');

            if (targetCard && targetCard !== dragged) {
                const draggedParent = dragged.parentNode;
                const targetParent = targetCard.parentNode;

                // визуален swap
                const draggedNext = dragged.nextSibling === targetCard ? dragged : dragged.nextSibling;
                const targetNext = targetCard.nextSibling === dragged ? targetCard : targetCard.nextSibling;

                targetParent.insertBefore(dragged, targetCard);
                draggedParent.insertBefore(targetCard, draggedNext);

                // вземаме PlayerId за AJAX
                const pos1 = parseInt(dragged.dataset.playerId);
                const pos2 = parseInt(targetCard.dataset.playerId);

                // извикване на контролера за swap в DB
                try {
                    const response = await fetch('/Home/SchemePositionChanger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pos1, pos2 })
                    });

                    if (!response.ok) throw new Error('Network error');

                    const data = await response.json();
                    console.log('DB updated:', data);

                    // актуализираме dataset, ако е нужно
                    dragged.dataset.playerId = data[0].PlayerId;
                    targetCard.dataset.playerId = data[1].PlayerId;

                } catch (err) {
                    console.error('Error updating SchemePosition:', err);
                    // при грешка може да върнем картите обратно
                }

            } else {
                // празно място – просто премести
                row.appendChild(dragged);
            }
        });
    });
        document.addEventListener('DOMContentLoaded', () => {
        // Всички бутони за starter
        document.querySelectorAll('.starter-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const playerId = parseInt(this.dataset.playerId);
                const schemePosition = parseInt(this.dataset.pos);
                if (!schemePosition) return;

                try {
                    const res = await fetch('/Home/MakeStarter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ PlayerId: playerId, SchemePosition: schemePosition })
                    });

                    if (!res.ok) throw new Error('Network error');

                    // Презареждаме страницата за визуализиране на новия starter
                    location.reload();

                } catch (err) {
                    console.error(err);
                    alert('Error making player starter');
                }
            });
        });
    });
</script>
